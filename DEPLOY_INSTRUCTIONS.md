# Инструкция по деплою Femida Admin

## Обновления в логике аутентификации

### Что изменилось:
1. **Добавлен middleware** (`middleware.ts`) - теперь все маршруты защищены на уровне сервера
2. **Создан хук useAuth** - централизованное управление аутентификацией
3. **Добавлен компонент ProtectedRoute** - защита маршрутов с индикатором загрузки
4. **Синхронизация localStorage и cookies** - токены сохраняются в обоих местах

### Как это решает проблему:
- **Больше нет "мелькания"** - middleware перенаправляет на `/login` до загрузки страницы
- **Правильная последовательность**: сначала логин, потом главная страница
- **Защита на уровне сервера** - неавторизованные пользователи не могут получить доступ к защищенным маршрутам

## Деплой на PythonAnywhere

### 1. Обновление кода
```bash
cd ~/femida-admin
git pull origin main
```

### 2. Активация виртуального окружения
```bash
cd backend
source venv/bin/activate
```

### 3. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 4. Миграции базы данных
```bash
python manage.py migrate
```

### 5. Сборка статических файлов
```bash
python manage.py collectstatic --noinput
```

### 6. Перезапуск приложения
- Зайдите в Web tab на PythonAnywhere
- Нажмите "Reload" для вашего приложения

## Деплой на Vercel (Frontend)

### 1. Автоматический деплой
- При пуше в main ветку Vercel автоматически деплоит изменения
- Убедитесь, что Root Directory установлен в `frontend`

### 2. Проверка настроек Vercel
- Root Directory: `frontend`
- Build Command: `npm run build`
- Output Directory: `.next`

## Тестирование

### 1. Проверка логики аутентификации
- Откройте приложение в режиме инкогнито
- Должна открыться страница логина
- После входа - главная страница
- При попытке зайти на `/` без авторизации - редирект на `/login`

### 2. Проверка выхода из системы
- Нажмите "Выйти" в хедере
- Должен произойти редирект на `/login`
- При попытке зайти на защищенные маршруты - редирект на `/login`

## Возможные проблемы

### 1. Middleware не работает
- Убедитесь, что файл `middleware.ts` находится в корне frontend папки
- Проверьте, что в `next.config.js` нет конфликтующих настроек

### 2. Cookies не сохраняются
- Проверьте настройки CORS на бэкенде
- Убедитесь, что домен настроен правильно

### 3. Бесконечная загрузка
- Проверьте консоль браузера на ошибки
- Убедитесь, что API_URL настроен правильно

## Структура файлов аутентификации

```
frontend/
├── middleware.ts              # Защита маршрутов на уровне сервера
├── src/
│   ├── components/
│   │   ├── ProtectedRoute.tsx # Компонент защиты маршрутов
│   │   └── ClientLayout.tsx   # Обновлен для использования ProtectedRoute
│   ├── shared/
│   │   └── hooks/
│   │       └── useAuth.ts     # Хук для управления аутентификацией
│   └── app/
│       ├── login/
│       │   └── page.tsx       # Обновлен для использования useAuth
│       └── page.tsx           # Убрана дублирующая проверка токена
``` 